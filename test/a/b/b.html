<!DOCTYPE html>
<html lang="en">

<head>
  <title></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .i18n {
      background-color: red;
    }
  </style>
</head>

<body>
  <p i18n-class="i18n">i18n-Class</p>
  <img src="" i18n-img="./imgs/${locale}/header-img.png" width="50" height="50">
  <div i18n-content="你好"></div>
  <input type="text" name="" i18n-placeholder="你好">
  <script>
    (function (win) {
      const util = {
        hasClass(ele, cls) {
          return new RegExp(cls).test(ele.className || '');
        },
        addClass(ele, cls) {
          var _pattern = new RegExp(cls);
          if (!_pattern.test(ele.className)) ele.className += ' ' + cls;
          return ele;
        },
        removeClass(ele, cls) {
          //添加对于DOM元素的判断
          if (!ele || ele.nodeType !== 1) return;
          var _pattern = new RegExp(cls);
          if (_pattern.test(ele.className || '')) ele.className = ele.className.replace(_pattern, '');
          return ele;
        }
      }

      class T {
        constructor(options) {
          this.locale = options.locale || 'zh'
          this.messages = options.messages || {}
        }

        $t(key, ...args) {
          let str = this.messages[this.locale][key]

          if (args.length === 1 && typeof args[0] === 'object') {
            args = args[0]
          } else {
            args = {}
          }

          if (!args || !args.hasOwnProperty) {
            args = {}
          }

          let RE_NARGS = /(%|)\{([0-9a-zA-Z_]+)\}/g

          return str.replace(RE_NARGS, (match, prefix, i, index) => {
            let result = ''
            if (str[index - 1] === '{' &&
              str[index + match.length] === '}') {
              return i
            } else {
              result = args.hasOwnProperty(i) ? args[i] : match
              if (!result) {
                return ''
              }

              return result
            }
          })
        }
      }

      const CLASS_ATTRIBUTE = 'i18n-class'
      const IMG_ATTRIBUTE = 'i18n-img'
      const CONTENT_ATTRIBUTE = 'i18n-content'
      const PLACEHOLDER_ATTRIBUTE = 'i18n-placeholder'
      const LOCALE_PATTERN = /\$\{locale}/g

      class DI18n extends T {
        constructor(options = {}) {
          super(options)

          this.locale = options.locale || 'en'
          this.messages = options.messages || {}
          this.isReplace = options.isReplace || false
          this.currMessage = this.messages[this.locale]
          this.doms = {}

          // 是否进行DOM内容的替换
          if (this.isReplace) {
            this.getDoms()

            this.handlerClass()
            this.handlerImg()
            this.handlerContent()
            this.handlerInput()
          }
        }

        getDoms() {
          this.doms = {
            classDoms: document.querySelectorAll(`[${CLASS_ATTRIBUTE}]`),
            imgDoms: document.querySelectorAll(`[${IMG_ATTRIBUTE}]`),
            contentDoms: document.querySelectorAll(`[${CONTENT_ATTRIBUTE}]`),
            inputDoms: document.querySelectorAll(`[${PLACEHOLDER_ATTRIBUTE}]`)
          }
        }

        handlerClass() {
          this.doms.classDoms.forEach((dom, index) => {
            util.addClass(dom, dom.getAttribute(CLASS_ATTRIBUTE))
          })
        }

        handlerImg() {
          this.doms.imgDoms.forEach((dom, index) => {
            let src = dom.getAttribute(IMG_ATTRIBUTE).replace(LOCALE_PATTERN, this.locale)
            dom.src = src
          })
        }

        handlerContent() {
          this.doms.contentDoms.forEach((dom, index) => {
            let content = dom.getAttribute(CONTENT_ATTRIBUTE)
            dom.innerHTML = this.messages[this.locale][content]
          })
        }

        handlerInput() {
          this.doms.inputDoms.forEach((dom, index) => {
            let placeHolderKey = dom.getAttribute(PLACEHOLDER_ATTRIBUTE)
            dom.setAttribute('placeholder', this.currMessage[placeHolderKey])
          })
        }
      }



      window.DI18n = DI18n
    })(window)

    // TODO 完成一个异步加载器
    // 完成静态内容的替换工作
    let di18n = new DI18n({
      local: 'zh',
      isReplace: true,
      messages: {
        en: {
          你好: 'Hello, {a}'
        },
        zh: {
          你好: '你好'
        }
      }
    })

    console.log(di18n.$t('你好', {a: 'xl'}))
  </script>
</body>

</html>